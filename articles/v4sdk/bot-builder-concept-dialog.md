---
title: 在 Bot Framework SDK 內的對話| Microsoft Docs
description: 說明什麼是對話，以及其在 Bot Builder SDK 內的運作方式。
keywords: 交談流程, 提示, 對話狀態, 辨識意圖, 單一回合, 多個回合, Bot 交談, 對話, 提示, 瀑布, 對話集
author: johnataylor
ms.author: johtaylo
manager: kamrani
ms.topic: article
ms.service: bot-service
ms.date: 05/23/2019
monikerRange: azure-bot-service-4.0
ms.openlocfilehash: 9dbb64dd941cdd7706b0ec8f7bd531530c8db59e
ms.sourcegitcommit: 312a4593177840433dfee405335100ce59aac347
ms.translationtype: HT
ms.contentlocale: zh-TW
ms.lasthandoff: 11/12/2019
ms.locfileid: "73933604"
---
# <a name="dialogs-library"></a>對話方塊程式庫

[!INCLUDE [applies-to-v4](../includes/applies-to.md)]

「對話」  是 SDK 的中心概念，可提供實用的方法來管理與使用者的交談。 對話是 Bot 中的結構，其作用類似 Bot 程式中的函式；每個對話的設計都是依照特定順序來執行特定工作。 您可以指定個別對話的順序來引導交談，並透過不同的方式叫用對話，有時透過給使用者的回應來叫用，有時透過給一些外部刺激的回應來叫用，也從其他對話來叫用。

Dialogs 程式庫會提供一些內建功能 (例如  「提示」  和「瀑布圖對話」)，讓 Bot 交談更易於管理。 [提示](#prompts)可用來詢問不同類型的資訊，例如文字、數字或日期。 [瀑布式對話](#waterfall-dialogs)可將多個步驟結合成一個序列，讓 Bot 能夠輕鬆地遵循該預先定義的序列，並將資訊傳遞至下一個步驟。

<!-- When we have samples for building your own, add links and one liner about them -->

## <a name="dialogs-and-their-pieces"></a>對話及其片段

Dialogs 程式庫包含一些額外的片段，可讓對話更有用。 除了下面討論的不同[對話類型](#dialog-types)，程式庫還包含「對話集」  、「對話內容」  和「對話結果」  的概念。

簡單來說，「對話集」  是對話的集合。 這可以是提示、瀑布式對話或[元件對話](#component-dialog)之類的事物。 每一項都是對話的實作，並且每一項都會新增至具有特定字串識別碼的對話集。 當 Bot 想要開始對話集內的特定對話或提示時，其會使用該字串識別碼來指定要使用哪個對話。

「對話內容」  包含屬於對話的資訊，且用來從 Bot 的回合處理常式內與對話集互動。 對話內容包含目前的回合內容、父代對話，以及[對話狀態](#dialog-state)，可供保留對話中的資訊。 對話內容可讓您開始一個具有其字串識別碼的對話，或繼續目前的對話 (例如具有多個步驟的瀑布式對話)。

當對話結束時，其可以傳回「對話結果」  ，以及來自對話的一些結果資訊。 傳回此資訊，讓呼叫方法看到對話中發生的狀況，並將資訊儲存至某個永續性位置 (如有需要)。

## <a name="dialog-state"></a>對話方塊狀態

對話是一種實作多回合交談邏輯的方法，因此，這是 SDK 中依賴多個回合中保存狀態的功能範例。 對話中若無狀態，Bot 便無法得知其位於對話集中的何處，或其已經蒐集哪些資訊。

對話式 Bot 通常會保留對話集合做為其 Bot 實作中的成員變數。 該對話集會透過存取子物件 (可供存取保存狀態) 的控點來建立。 如需 Bot 內狀態的背景，請參閱[管理狀態](bot-builder-concept-state.md)。

在 Bot 的開啟回合處理常式內，Bot 會藉由在對話集上呼叫 *create context* 來初始化對話子系統，以傳回「對話內容」  。 該對話內容包含對話所需的必要資訊。

建立對話內容時需要狀態，透過建立對話集時所提供的存取子即可存取狀態。 對話集可以透過存取子，取得適當的對話狀態。 在[儲存交談和使用者資料](bot-builder-howto-v4-state.md)中可找到狀態存取子的詳細資料。

## <a name="dialog-types"></a>對話類型

對話有幾個不同的類型：提示、瀑布式對話和元件對話，如此類別階層所示。

![對話方塊類別](media/bot-builder-dialog-classes.png)

### <a name="prompts"></a>提示

Dialogs 程式庫中的提示，可讓您輕鬆地向使用者詢問資訊並評估其回應。 例如對於「數字提示」  ，您可指定所詢問的問題或資訊，而提示會自動查看其是否收到有效的數字回應。 如果收到，交談即可繼續；如果未收到，則會重新提示使用者輸入有效的答案。

在幕後，提示為兩個步驟的對話方塊。 第一步，提示會要求輸入；第二步，其會傳回有效值，或利用重新提示從頂端開始。

呼叫提示時，提示會有「提示選項」  ，您可以在其中指定要提示的文字、驗證失敗時的重試提示，以及回答提示的選項。 一般而言，prompt 和 retry prompt 屬性都是活動，雖然其在不同程式設計語言中的處理方式有一些差異。

此外，您可以在建立提示時，選擇為您的提示新增一些自訂驗證。 例如，假設我們想要使用數字提示來取得派對大小，但該派對大小必須大於 2 且小於 12。 提示會先查看其是否收到有效數字，然後執行自訂驗證 (若已提供)。 如果自訂驗證失敗，則會如上所述重新提示使用者。

提示完成時，其會明確地傳回所要求的結果值。 傳回該值後，我們可以確定其已通過內建的提示驗證及任何其他可能已提供的自訂驗證。

如需使用各種提示的範例，請查看如何使用 [Dialogs 程式庫來收集使用者輸入](bot-builder-prompts.md)。

#### <a name="prompt-types"></a>提示類型

在幕後，提示為兩個步驟的對話方塊。 第一步，提示會要求輸入；第二步，會傳回有效值，或利用重新提示從頂端重新開始。 對話方塊 程式庫提供數個基本提示，分別用於收集不同類型的回應。 基本提示可解譯自然語言輸入，例如 "ten" 或 "a dozen" 是指數字，或 "tomorrow" 或 "Friday at 10am" 是指日期時間。

| Prompt | 說明 | 傳回 |
|:----|:----|:----|
| _附件提示_ | 要求一或多個附件，例如文件或影像。 | 「附件」  物件的集合。 |
| _選擇提示_ | 要求從一組選項中選擇。 | 「找到的選擇」  物件。 |
| _確認提示_ | 要求確認。 | 布林值。 |
| _日期時間提示_ | 要求日期時間。 | 「日期時間解析」  物件的集合。 |
| _數字提示_ | 要求數字。 | 數值。 |
| _文字提示_ | 要求一般文字輸入。 | 字串。 |

若要提示使用者提供輸入，請使用其中一個內建類別 (例如_文字提示_) 定義提示，然後將其新增至對話方塊集。 提示已修正在對話集內必須是唯一的識別碼。 您可以讓每個提示都有自訂驗證程式，而對於某些提示，您可以指定「預設地區設定」  。 

#### <a name="prompt-locale"></a>提示地區設定

地區設定用來決定**選擇**、**確認**、**日期時間**和**數字**提示的特定語言行為。 對於來自使用者的任何指定輸入，如果通道在使用者的訊息中提供了 _locale_ 屬性，則會使用該屬性。 否則，如果在呼叫提示的建構函式時提供提示的「預設地區設定」  ，或藉由稍後設定，則會使用該預設地區設定。 若未提供任何一項，則會以英文 ("en-us") 作為地區設定。 注意：地區設定是 2、3 或 4 個字元的 ISO 639 代碼，其代表某個語言或語言系列。

### <a name="waterfall-dialogs"></a>瀑布式對話

瀑布式對話是特定的對話實作，常用來向使用者收集資訊或引導使用者完成一系列的工作。 每個交談步驟都會以非同步函式的形式實作，而且採用「瀑布式步驟內容」  (`step`) 參數。 在每個步驟中，Bot 會[提示使用者提供輸入](bot-builder-prompts.md) (或者可以開始子對話，但這通常是提示)、等候回應，然後將結果傳遞給下一個步驟。 第一個函式的結果將作為引數傳遞至下一個函式，依此類推。

下圖顯示瀑布步驟序列和所發生的堆疊作業。 底下的[使用對話](#using-dialogs)一節會詳細說明對話堆疊的使用方式。

![對話方塊概念](media/bot-builder-dialog-concept.png)

在瀑布式步驟內，瀑布式對話的內容會儲存在其*瀑布式步驟內容*中。 這類似於對話內容，因為其可供存取目前的回合內容和狀態。 請使用瀑布步驟內容物件，從瀑布步驟內與對話方塊集合互動。

您所能處理的傳回值可來自對話中瀑布式步驟內的對話，或來自 Bot 的開啟回合處理常式，儘管您通常只需要檢查 Bot 回合邏輯的對話回合結果狀態。
在瀑布步驟內，對話方塊會在瀑布步驟內容的「結果」  屬性中提供傳回值。

#### <a name="waterfall-step-context-properties"></a>瀑布式步驟內容屬性

瀑布式步驟內容包含下列各項：

* *選項*：包含對話的輸入資訊。
* *值*：包含您可以新增至內容，而後轉入後續步驟中的資訊。
* *結果*：包含上一個步驟的結果。

此外，next  方法 (C# 中的 **NextAsync**，JS 中的 **next**) 會繼續進行相同回合中瀑布式對話的下一個步驟，並且讓 Bot 視需要略過特定步驟。

#### <a name="prompt-options"></a>提示選項

步驟內容 _prompt_ 方法的第二個參數會採用_提示選項_物件，其具有下列屬性。

| 屬性 | 說明 |
| :--- | :--- |
| _Prompt_ | 要傳送給使用者、要求他們輸入的初始活動。 |
| _Retry prompt_ | 如果使用者的第一項輸入未經驗證，要傳送給使用者的活動。 |
| _Choices_ | 可供使用者從中選擇、搭配選擇提示使用的選擇清單。 |
| _Validations_ | 要與自訂驗證程式搭配使用的其他參數。 |
| _Style_ | 定義要如何對使用者提供選項提示或確認提示的選項。 | 

請一律要指定傳送給使用者的初始提示活動，以及使用者的輸入未驗證時的執行個體重試提示。 

如果使用者輸入無效，便會傳送重試提示給使用者；如果未指定任何重試，則會重新傳送初始提示。 不過，如果從驗證程式內回傳活動給使用者，便不會傳送任何重試提示。 

##### <a name="prompt-validation"></a>提示驗證 

您可以先驗證提示回應，再將值傳回至瀑布的下一個步驟。 驗證程式函式具有「提示驗證程式內容」  參數並且會傳回布林值，指出輸入是否通過驗證。
提示驗證程式內容包含下列屬性：

| 屬性 | 說明 |
| :--- | :--- |
| _內容_ | Bot 目前的回合內容。 |
| _Recognized_ | 「提示辨識器結果」  ，其中包含使用者輸入的相關資訊 (如辨識器所處理)。 |
| _選項_ | 包含在呼叫中所提供用來啟動提示的「提示選項」  。 |

提示辨識器結果具有下列屬性：

| 屬性 | 說明 |
| :--- | :--- |
| _已成功_ | 表示辨識器是否能夠剖析輸入。 |
| _值_ | 來自辨識器的傳回值。 如有必要，驗證碼可以修改此值。 |

### <a name="component-dialog"></a>元件對話方塊

您有時想要撰寫可重複使用的對話，以便使用於不同的案例中，例如要求使用者提供街道、城市和郵遞區號值的地址對話。

「元件對話」  提供以下策略：建立獨立的對話來處理特定案例，並將大型對話集分割成更多可管理的片段。 這些片段都有自己的對話集，而且會避免與所屬對話集發生任何名稱衝突。 請參閱[元件對話操作說明](bot-builder-compositcontrol.md)，以獲得詳細資訊。

## <a name="using-dialogs"></a>使用對話

您可以使用對話內容來開始、繼續、取代或結束對話。 您也可以取消對話堆疊上的所有對話。

對話可被視為程式設計堆疊，我們稱之為「對話堆疊」  ，其由回合處理常式引導，而如果堆疊是空的，則會作為後援。 該堆疊最上方的項目會被視為「作用中對話」  ，而對話內容會將所有輸入導向作用中對話。

當對話開始時，其會推送至堆疊，而成為作用中對話。 其會在結束前保持為作用中對話，而 [replace dialog](#repeating-a-dialog) 方法會將它移除，或另一個對話會推送至堆疊 (經由回合處理常式或作用中對話本身) 並成為作用中對話。 當新的對話結束時，其就會從堆疊中彈出，而下一個對話會再度成為作用中對話。 這可允許[重複對話方塊](#repeating-a-dialog)或[建立對話分支](#branch-a-conversation)，如下所述。


### <a name="create-the-dialog-context"></a>建立對話內容

若要建立對話內容，請呼叫對話集的 create context  方法。 「建立內容」可取得對話集的「對話狀態」  屬性，並使用其來建立對話內容。 然後對話內容用來開始、繼續或者控制集合中的對話。

對話集需要使用「狀態屬性存取子」  來存取對話狀態。 存取子的建立和使用方式與其他狀態存取子相同，但是會根據交談狀態建立為其自己的專屬屬性。 在[管理狀態主題](bot-builder-concept-state.md)中可找到管理狀態的詳細資訊，而對話狀態的使用方式則會顯示在[循序交談流程](bot-builder-dialog-manage-conversation-flow.md)操作說明中。

### <a name="to-start-a-dialog"></a>開始對話方塊

若要開始對話，請將您要開始的「對話識別碼」  傳遞到對話內容的 begin dialog  、prompt  或 replace dialog  方法。

* begin dialog 方法會將對話推送至堆疊的頂端。
* replace dialog 方法會將目前的對話從堆疊取出，並將取代對話推送至堆疊。 被取代的對話已被取消，而該執行個體包含的資訊已處置。

使用 options  參數，將資訊傳遞至對話的新執行個體。
傳遞至新對話方塊的選項，可透過步驟內容在任何對話方塊步驟中的「選項」  屬性來存取。
如需範例程式碼，請參閱[使用分支和迴圈建立進階交談流程](bot-builder-dialog-manage-complex-conversation-flow.md)操作說明。

### <a name="to-continue-a-dialog"></a>繼續對話

若要繼續對話，請呼叫 continue dialog  方法。 如果有作用中對話，continue 方法一律會繼續進行堆疊最上層的對話 (作用中對話)。 如果持續的對話結束，則控制權會傳給在相同回合中繼續的父代內容。

使用步驟內容的 values  屬性，以保存回合之間的狀態。
在後續回合中可使用在先前回合中新增至這個集合的值。
如需範例程式碼，請參閱[使用分支和迴圈建立進階交談流程](bot-builder-dialog-manage-complex-conversation-flow.md)操作說明。

### <a name="to-end-a-dialog"></a>結束對話方塊

end dialog  方法可將對話從堆疊中取出，並將選擇性結果傳回給父代內容 (例如呼叫它的對話，或 Bot 的回合處理常式)，以結束對話。 此方法最常從對話中進行呼叫，以結束本身目前的執行個體。

您可以從具有對話內容的任何地方呼叫 end dialog 方法，但是會對 Bot 顯示為從目前作用中的對話進行呼叫。

> [!TIP]
> 最好是在對話結束時，明確地呼叫 end dialog  方法。

### <a name="to-clear-all-dialogs"></a>清除所有對話

如果您想要將所有對話方塊從堆疊中移除，您可以藉由呼叫對話方塊內容的 cancel all dialogs  方法來清除對話方塊堆疊。

### <a name="repeating-a-dialog"></a>重複對話方塊

您可以使用*取代對話方塊*方法取代對話方塊本身，進而建立迴圈。
這很適合用來處理[複雜的反覆運作](~/v4sdk/bot-builder-dialog-manage-complex-conversation-flow.md)，也是管理功能表的好方法。

> [!NOTE]
> 如果您需要保存目前對話的內部狀態，則必須將資訊傳遞給 replace dialog  方法呼叫中的新對話執行個體，然後適當地將對話初始化。

### <a name="branch-a-conversation"></a>產生對話分支

對話內容會維護對話堆疊，並針對堆疊上的每個對話，追蹤接下來是哪個步驟。 begin dialog  方法會建立一個子項目並將對話推送至堆疊頂端，而其 end dialog  方法則會將頂端對話從堆疊中取出。 End dialog  通常會從即將結束的對話中進行呼叫。

對話方塊可以藉由呼叫對話方塊內容的「開始對話方塊」  方法，並提供新對話方塊的識別碼，在同一對話集合內開始新的對話方塊，然後讓新的對話成為目前使用中的對話方塊。 原始對話方塊仍在堆疊中，但呼叫對話方塊內容的「繼續 (continue) 對話方塊」  方法只會傳送到堆疊頂端的對話方塊，也就是「使用中的對話方塊」  。 當對話方塊從堆疊中移除時，對話方塊內容會從原始對話方塊停止的地方，繼續 (resume) 使用堆疊中瀑布的下一個步驟。

因此，藉由包含在對話方塊中，可以有條件地從一組可用的對話方塊中選擇對話方塊來開始的步驟，您即可在對話流程內建立分支。

## <a name="next-steps"></a>後續步驟

> [!div class="nextstepaction"]
> [使用對話方塊程式庫來收集使用者輸入](bot-builder-prompts.md)
